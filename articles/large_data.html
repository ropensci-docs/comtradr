<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="comtradr">
<title>Querying large amounts of data • comtradr</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Querying large amounts of data">
<meta property="og:description" content="comtradr">
<meta property="og:image" content="https://docs.ropensci.org/comtradr/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">comtradr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.4.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../articles/comtradr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/caching.html">Caching requests from the UN Comtrade API</a>
    <a class="dropdown-item" href="../articles/large_data.html">Querying large amounts of data</a>
    <a class="dropdown-item" href="../articles/transition.html">Transition from old comtradr</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/comtradr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Querying large amounts of data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/comtradr/blob/HEAD/vignettes/large_data.Rmd" class="external-link"><code>vignettes/large_data.Rmd</code></a></small>
      <div class="d-none name"><code>large_data.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/comtradr/">comtradr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="the-limits">The limits<a class="anchor" aria-label="anchor" href="#the-limits"></a>
</h3>
<p>When you are on the free API tier, you will encounter two limits when wanting to calculate on rather large datasets:</p>
<ol style="list-style-type: decimal">
<li><p>you can only make 500 calls per day,</p></li>
<li><p>of which each can take up to 100.000 rows.</p></li>
</ol>
<p>This information might be updated in the Comtrade API, check the most up to date values <a href="https://unstats.un.org/wiki/display/comtrade/New+Comtrade+FAQ+for+First+Time+Users#NewComtradeFAQforFirstTimeUsers-WhichsubscriptionscanIchoosefrom?" class="external-link">here</a>.</p>
<p>So when trying to fetch the maximum amount of data in the minimum amount of days, you want to minimize the amount of requests you need by making them as comprehensive as possible, without ever exceeding the 100k row limit.</p>
</div>
<div class="section level3">
<h3 id="the-example---imports-of-the-eu">The example - Imports of the EU<a class="anchor" aria-label="anchor" href="#the-example---imports-of-the-eu"></a>
</h3>
<p>Let’s say, we want to know which is the top exporter of the EU in each product class of the Harmonic System. This could be useful, when thinking about dependencies between countries, e.g. when evaluating the usefulness or impact of Regulation such as the <a href="https://environment.ec.europa.eu/topics/forests/deforestation/regulation-deforestation-free-products_en" class="external-link">EUDR Regulation</a>. Quoting from the <a href="https://tradebriefs.intracen.org/2023/11/spotlight" class="external-link">ITC</a>: “Under the regulation that entered into force on 29 June 2023, any operator or trader placing [specific] commodities on the EU market or exporting them from the EU, has to be able to prove that the goods do not originate from deforested land (cutoff date 31 December 2020) or contribute to forest degradation”. One question that arises would be, what are the impacts of this regulation on other countries and which of these is particularly important to the EU?</p>
<p>Let’s replicate some of their numbers, e.g. the relevance to the EU indicator from the map of the ITC spotlight cited above.</p>
<p><em>What is the share of one country in the EU’s imports of a product?</em></p>
<p>Remember, to get Comtrade data, we need the Commodity Codes, the respective iso3 codes for the countries and a time frame.</p>
<div class="section level4">
<h4 id="what-are-the-commodity-codes">1. What are the commodity codes?<a class="anchor" aria-label="anchor" href="#what-are-the-commodity-codes"></a>
</h4>
<p>First we need to find out, which HS codes, or which goods are affected. We look at Annex 1 of the <a href="https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX%3A32023R1115&amp;qid=1687867231461" class="external-link">Regulation</a>. This gives us more or less the following list of commodities for the product class ‘Wood’.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wood</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"4401"</span>,</span>
<span>    <span class="st">"4402"</span>,</span>
<span>    <span class="st">"4403"</span>,</span>
<span>    <span class="st">"4404"</span>,</span>
<span>    <span class="st">"4405"</span>,</span>
<span>    <span class="st">"4406"</span>,</span>
<span>    <span class="st">"4407"</span>,</span>
<span>    <span class="st">"4408"</span>,</span>
<span>    <span class="st">"4409"</span>,</span>
<span>    <span class="st">"4410"</span>,</span>
<span>    <span class="st">"4411"</span>,</span>
<span>    <span class="st">"4412"</span>,</span>
<span>    <span class="st">"4413"</span>,</span>
<span>    <span class="st">"4414"</span>,</span>
<span>    <span class="st">"4415"</span>,</span>
<span>    <span class="st">"4416"</span>,</span>
<span>    <span class="st">"4417"</span>,</span>
<span>    <span class="st">"4418"</span>,</span>
<span>    <span class="st">"4419"</span>,</span>
<span>    <span class="st">"4420"</span>,</span>
<span>    <span class="st">"4421"</span>,</span>
<span>    <span class="st">"940330"</span>,</span>
<span>    <span class="st">"940340"</span>,</span>
<span>    <span class="st">"940350"</span>,</span>
<span>    <span class="st">"940360"</span>,</span>
<span>    <span class="st">"940391"</span>,</span>
<span>    <span class="st">"940610"</span>,</span>
<span>    <span class="st">"4701"</span>,</span>
<span>    <span class="st">"4702"</span>,</span>
<span>    <span class="st">"4703"</span>,</span>
<span>    <span class="st">"4704"</span>,</span>
<span>    <span class="st">"4705"</span>,</span>
<span>    <span class="st">"470610"</span>, </span>
<span>    <span class="st">"470691"</span>, </span>
<span>    <span class="st">"470692"</span>, </span>
<span>    <span class="st">"470693"</span>,</span>
<span>    <span class="st">"48"</span>,</span>
<span>    <span class="st">"49"</span>,</span>
<span>    <span class="st">"9401"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">wood_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cmd_code <span class="op">=</span> <span class="va">wood</span>, product_cat <span class="op">=</span> <span class="st">"wood"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="which-are-the-countries">2. Which are the countries?<a class="anchor" aria-label="anchor" href="#which-are-the-countries"></a>
</h4>
<p>First we need a list of the EU27 countries as iso3 codes. I use the <code>giscoR</code> package to get this information quickly.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eu_countries</span> <span class="op">&lt;-</span> <span class="fu">giscoR</span><span class="fu">::</span><span class="va">gisco_countrycode</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">eu</span> <span class="op">==</span> <span class="cn">T</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">ISO3_CODE</span><span class="op">)</span></span></code></pre></div>
<p>Secondly, we need a vector for all other countries, but we can get this easily by just specifying <code>all_countries</code> in the parameter to the partner argument.</p>
</div>
</div>
<div class="section level3">
<h3 id="getting-the-data">Getting the data<a class="anchor" aria-label="anchor" href="#getting-the-data"></a>
</h3>
<p>To calculate the relevance of a product category to the EU, we need to calculate the following:</p>
<p><span class="math inline">\(\text{Import Relevance to EU in %} = \frac{\sum_{c \in \text{EU27}} I_{c,p}}{\sum_{c \in \text{EU27}} W_{c,p}}\)</span></p>
<p>Where:</p>
<ul>
<li>
<span class="math inline">\(I_{c,p}\)</span>: Imports of EU country c in product category <span class="math inline">\(p\)</span> from a specific non-EU country.</li>
<li>
<span class="math inline">\(W_{c,p}\)</span>: Total imports of EU country <span class="math inline">\(c\)</span> in product category <span class="math inline">\(p\)</span> from the world.</li>
</ul>
<p>In plain English, we need to know how much of a given product comes from one country and which share of the total imports it has.</p>
<p>Let’s get <span class="math inline">\(I_{c,p}\)</span> first.</p>
<div class="section level4">
<h4 id="eu-imports-from-all-countries">EU imports from all countries<a class="anchor" aria-label="anchor" href="#eu-imports-from-all-countries"></a>
</h4>
<p>If you were to execute this query, you will get a return object that contains exactly 100k rows and a warning, that if you did not intend to get exactly 100k rows, you have most likely hit the limit.</p>
<p>This seems natural in this case, as we are trying to get data on about 39 commodity classes for 27 EU countries as reporters and about 190 partners in 4 years. This equals to potentially 800k rows.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_eu_imports</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ct_get_data.html">ct_get_data</a></span><span class="op">(</span></span>
<span>    commodity_code <span class="op">=</span> <span class="va">wood</span>,</span>
<span>    reporter <span class="op">=</span> <span class="va">eu_countries</span>,</span>
<span>    partner <span class="op">=</span> <span class="st">"all_countries"</span>,</span>
<span>    flow_direction <span class="op">=</span> <span class="st">"import"</span>,</span>
<span>    start_date <span class="op">=</span> <span class="fl">2018</span>,</span>
<span>    end_date <span class="op">=</span> <span class="fl">2022</span></span>
<span>  <span class="op">)</span> </span></code></pre></div>
<p>Let’s break this down into a simple loop. We could iterate over years, but that would only get us down to about 200k rows for each year. Since we have 250 calls per day, let’s just iterate over each eu country and get the data separately.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## initiate a new instance of an empty tibble()</span></span>
<span><span class="va">data_eu_imports</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">reporter</span> <span class="kw">in</span> <span class="va">eu_countries</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">## for a simple status, print the country we are at </span></span>
<span>  <span class="co">## you can get a lot fancier with the library `progress` for progress bars</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reporter</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## assign the result into a temporary object</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ct_get_data.html">ct_get_data</a></span><span class="op">(</span></span>
<span>    commodity_code <span class="op">=</span> <span class="va">wood</span>,</span>
<span>    reporter <span class="op">=</span> <span class="va">reporter</span>,</span>
<span>    partner <span class="op">=</span> <span class="st">"all_countries"</span>,</span>
<span>    flow_direction <span class="op">=</span> <span class="st">"import"</span>,</span>
<span>    start_date <span class="op">=</span> <span class="fl">2018</span>,</span>
<span>    end_date <span class="op">=</span> <span class="fl">2022</span></span>
<span>  <span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co">## bind the subset to the complete data</span></span>
<span>  <span class="va">data_eu_imports</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">data_eu_imports</span>, <span class="va">temp</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## note that I did not include any sleep() command here to make the requests</span></span>
<span>  <span class="co">## wait for a specified amount of time, the package keeps track of that for </span></span>
<span>  <span class="co">## you automatically and backs off when needed</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_eu_imports</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 173358</span></span></code></pre></div>
<p>Congratulations, you have now queried 170k rows of data, exceeding the limit of one call to the API!</p>
<p>Getting the data for imports from the World, <span class="math inline">\(W_{c,p}\)</span>, should be easy now!</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_eu_imports_world</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ct_get_data.html">ct_get_data</a></span><span class="op">(</span></span>
<span>    commodity_code <span class="op">=</span> <span class="va">wood</span>,</span>
<span>    reporter <span class="op">=</span> <span class="va">eu_countries</span>,</span>
<span>    partner <span class="op">=</span> <span class="st">"World"</span>,</span>
<span>    flow_direction <span class="op">=</span> <span class="st">"import"</span>,</span>
<span>    start_date <span class="op">=</span> <span class="fl">2018</span>,</span>
<span>    end_date <span class="op">=</span> <span class="fl">2022</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_eu_imports_world</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5004</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="data-cleaning">Data cleaning<a class="anchor" aria-label="anchor" href="#data-cleaning"></a>
</h4>
<pre><code><span><span class="co">#&gt; `summarise()` has grouped output by 'partner_iso', 'partner_desc', 'flow_desc',</span></span>
<span><span class="co">#&gt; 'product_cat'. You can override using the `.groups` argument.</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_eu_imports_world_clean</span> <span class="op">&lt;-</span> <span class="va">data_eu_imports_world</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">wood_df</span>, by <span class="op">=</span> <span class="st">"cmd_code"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">reporter_iso</span>,</span>
<span>    <span class="va">reporter_desc</span>,</span>
<span>    <span class="va">flow_desc</span>,</span>
<span>    <span class="va">partner_iso</span>,</span>
<span>    <span class="va">partner_desc</span>,</span>
<span>    <span class="va">cmd_code</span>,</span>
<span>    <span class="va">cmd_desc</span>,</span>
<span>    <span class="va">product_cat</span>,</span>
<span>    <span class="va">primary_value</span>,</span>
<span>    <span class="va">ref_year</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## we now aggregate the imports by the product category and year </span></span>
<span>    <span class="co">## over all reporters, since we are interested </span></span>
<span>    <span class="co">## in the imports of the whole EU</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">product_cat</span>, <span class="va">ref_year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>eu_import_product_cat_world <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">primary_value</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'product_cat'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#### relevance to EU</span></span>
<span><span class="va">relevance</span> <span class="op">&lt;-</span> <span class="va">data_eu_imports_clean</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">data_eu_imports_world_clean</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">## join the two datasets</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>relevance_eu <span class="op">=</span> <span class="va">eu_import_product_cat</span><span class="op">/</span></span>
<span>           <span class="va">eu_import_product_cat_world</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">## calculate the ratio between world imports and imports from one partner |&gt; </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span> <span class="op">-</span><span class="va">flow_desc</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>  </span>
<span><span class="co">#&gt; Joining with `by = join_by(product_cat, ref_year)`</span></span></code></pre></div>
<p>Let’s see who has the biggest share in the EU import market for wood (excluding EU countries).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">top_10</span> <span class="op">&lt;-</span> <span class="va">relevance</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">partner_iso</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">eu_countries</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ref_year</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">relevance_eu</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">partner_desc</span>, <span class="va">relevance_eu</span>, <span class="va">ref_year</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">ref_year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">top_10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   ref_year [1]</span></span></span>
<span><span class="co">#&gt;    partner_desc       relevance_eu ref_year</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> China                     7.77      <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> USA                       2.03      <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Brazil                    1.96      <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> United Kingdom            1.95      <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Türkiye                   1.19      <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Ukraine                   1.07      <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Russian Federation        0.971     <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Switzerland               0.876     <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Norway                    0.799     <span style="text-decoration: underline;">2</span>022</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Indonesia                 0.656     <span style="text-decoration: underline;">2</span>022</span></span></code></pre></div>
<p>Let’s also do a little sanity check. When summing up all the shares over one year, we should get to 100 %. This seems to hold.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">relevance</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ref_year</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">relevance_eu</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span></span>
<span><span class="co">#&gt;   ref_year   sum</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     <span style="text-decoration: underline;">2</span>018  100.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     <span style="text-decoration: underline;">2</span>019  100.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     <span style="text-decoration: underline;">2</span>020  100.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     <span style="text-decoration: underline;">2</span>021  100.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     <span style="text-decoration: underline;">2</span>022  100.</span></span></code></pre></div>
<p>Maybe the last year was an outlier? We can calculate the mean relevante a country had in the past 5 years and get the most important countries again.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">average_share</span> <span class="op">&lt;-</span> <span class="va">relevance</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">partner_iso</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">eu_countries</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">partner_iso</span>, <span class="va">partner_desc</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_relevance_eu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">relevance_eu</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">mean_relevance_eu</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'partner_iso'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">average_share</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">partner_desc</span>,<span class="va">mean_relevance_eu</span><span class="op">)</span>, <span class="va">mean_relevance_eu</span><span class="op">)</span>, </span>
<span>           fill <span class="op">=</span> <span class="st">'brown'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Share of EU imports'</span>, </span>
<span>       subtitle <span class="op">=</span> <span class="st">'as average over last 4 years'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'average relevance in %'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">''</span><span class="op">)</span></span></code></pre></div>
<p><img src="large_data_files/figure-html/unnamed-chunk-18-1.png" width="960"></p>
</div>
</div>
<div class="section level3">
<h3 id="caveat-on-trade-dependencies">Caveat on trade “dependencies”<a class="anchor" aria-label="anchor" href="#caveat-on-trade-dependencies"></a>
</h3>
<p>However, several important caveats are to be made. I have not addressed these, because this vignette is about how to query larger data, not about trade dependencies per se. Hence a real-world example, but without all the complications that you would have to address for a valid analysis.</p>
<ol style="list-style-type: decimal">
<li><p>Dependency on a certain country in terms of how much of a product others import from them, does not equal dependency in terms of this product, as a country might have a substantial production of such items domestically. E.g. if (hypothetically) Argentina would import 90% of its wine from Chile that would not imply that Argentina depends on wine from Chile, if Argentina themselves produce a substantive amount of wine.</p></li>
<li><p>We included in our calculation of the total imports of the EU, imports from other EU countries, a.k.a. intra-EU imports. That would mean we probably underestimate how much of total EU imports really come from partner countries outside the EU.</p></li>
<li><p>Some of the HS codes for wood are not completely to be included per the Regulation, but I have spared us the intricacies of which ones and how to exclude them here.</p></li>
<li><p>Imports data is already better than exports data, because countries have an incentive to get good data to charge tariffs, however the best data for the EU comes from Eurostat, not Comtrade. But since this is about the Comtrade data, it will have to do.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
